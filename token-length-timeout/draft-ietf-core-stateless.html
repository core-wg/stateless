<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Extended Tokens and Stateless Clients in the Constrained Application Protocol (CoAP)</title>
<meta content="Klaus Hartke" name="author">
<meta content="
       
        This document provides considerations for alleviating CoAP clients and
        intermediaries of keeping per-request state. To facilitate this, this
        document additionally introduces a new, optional CoAP protocol extension
        for extended token lengths.
       
       
        This document updates RFCs 7252 and 8323 with a new definition of the
        TKL field in the CoAP message header.
       
    " name="description">
<meta content="xml2rfc 3.2.1" name="generator">
<meta content="draft-ietf-core-stateless-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.2.1
    Python 3.6.3
    appdirs 1.4.4
    ConfigArgParse 1.2.3
    google-i18n-address 2.4.0
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 2.11.2
    kitchen 1.2.6
    lxml 4.5.2
    pycountry 20.7.3
    pyflakes 2.2.0
    PyYAML 5.3.1
    requests 2.24.0
    setuptools 38.2.4
    six 1.11.0
-->
<link href="draft-ietf-core-stateless.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@import url('https://martinthomson.github.io/i-d-template/fonts.css');

html {
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --small-font-size: 14.5px;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
#title {
  padding: 1em 0 0.2em;
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1, h2, h3 {
  font-size: 22px;
  line-height: 26px;
}
h4, h5, h6 {
  font-size: 18px;
  line-height: 22px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p, #abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 18px;
  line-height: 24px;
}
p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
dd.break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href].selfRef {
  color: var(--text-color);
}
a[href] {
  color: var(--link-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px 'Oxygen Mono', monospace;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  pre {
    display: inline-block;
    overflow-x: auto;
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  pre + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
  table {
    display: inline-block;
    overflow-x: auto;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
tr:nth-child(2n) > td {
  background-color: var(--background-color);
}
tr:nth-child(2n+1) > td {
  background-color: var(--highlight-color);
}
thead+tbody > tr:nth-child(2n) > td {
  background-color: var(--highlight-color);
}
thead+tbody > tr:nth-child(2n+1) > td {
  background-color: var(--background-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  visibility: hidden;
  user-select: none;
}
a.pilcrow[href] { color: #ddd; }
a.pilcrow[href]:hover { text-decoration: none; }
@media screen {
  :hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 8em;
}
#identifiers dt {
  width: var(--identifier-width);
  margin: 0;
  clear: left;
  float: left;
  text-align: right;
}
#identifiers dd {
  margin: 0 0 0 calc(1em + var(--identifier-width));
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 500px) {
  .index ul {
    column-count: 2;
    column-gap: 20px;
  }
  .index ul ul {
    column-count: 1;
    column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul p, #toc ul li {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table .text-left, table .text-left {
  text-align: left;
}
table .text-center, table .text-center {
  text-align: center;
}
table .text-right, table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Give the table caption label the same styling as the figcaption */

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  dd {
    page-break-before: avoid;
  }
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
</style>

</head>
<body>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">Extended Tokens and Stateless Clients in</td>
<td class="right">October 2020</td>
</tr></thead>
<tfoot><tr>
<td class="left">Hartke</td>
<td class="center">Expires 4 April 2021</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">CoRE Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-core-stateless-latest</dd>
<dt class="label-updates">Updates:</dt>
<dd class="updates">
<a href="https://www.rfc-editor.org/rfc/rfc7252" class="eref">7252</a>, <a href="https://www.rfc-editor.org/rfc/rfc8323" class="eref">8323</a> (if approved)</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2020-10-01" class="published">1 October 2020</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2021-04-04">4 April 2021</time></dd>
<dt class="label-authors">Author:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">K. Hartke</div>
<div class="org">Ericsson</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Extended Tokens and Stateless Clients in the Constrained Application Protocol (CoAP)</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">
        This document provides considerations for alleviating CoAP clients and
        intermediaries of keeping per-request state. To facilitate this, this
        document additionally introduces a new, optional CoAP protocol extension
        for extended token lengths.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
<p id="section-abstract-2">
        This document updates RFCs 7252 and 8323 with a new definition of the
        TKL field in the CoAP message header.<a href="#section-abstract-2" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 4 April 2021.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2020 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a><a href="#section-toc.1-1.1.1" class="pilcrow">¶</a></p>
<ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="xref">1.1</a>.  <a href="#name-terminology" class="xref">Terminology</a><a href="#section-toc.1-1.1.2.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc compact ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="xref">2</a>.  <a href="#name-extended-tokens" class="xref">Extended Tokens</a><a href="#section-toc.1-1.2.1" class="pilcrow">¶</a></p>
<ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1" class="keepWithNext"><a href="#section-2.1" class="xref">2.1</a>.  <a href="#name-extended-token-length-tkl-f" class="xref">Extended Token Length (TKL) Field</a><a href="#section-toc.1-1.2.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.2.2.2">
                <p id="section-toc.1-1.2.2.2.1"><a href="#section-2.2" class="xref">2.2</a>.  <a href="#name-discovering-support" class="xref">Discovering Support</a><a href="#section-toc.1-1.2.2.2.1" class="pilcrow">¶</a></p>
<ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.2.2.2.2.1">
                    <p id="section-toc.1-1.2.2.2.2.1.1"><a href="#section-2.2.1" class="xref">2.2.1</a>.  <a href="#name-extended-token-length-capab" class="xref">Extended-Token-Length Capability Option</a><a href="#section-toc.1-1.2.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="toc compact ulEmpty" id="section-toc.1-1.2.2.2.2.2">
                    <p id="section-toc.1-1.2.2.2.2.2.1"><a href="#section-2.2.2" class="xref">2.2.2</a>.  <a href="#name-trial-and-error" class="xref">Trial-and-Error</a><a href="#section-toc.1-1.2.2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.2.2.3">
                <p id="section-toc.1-1.2.2.3.1"><a href="#section-2.3" class="xref">2.3</a>.  <a href="#name-intermediaries" class="xref">Intermediaries</a><a href="#section-toc.1-1.2.2.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc compact ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-stateless-clients" class="xref">Stateless Clients</a><a href="#section-toc.1-1.3.1" class="pilcrow">¶</a></p>
<ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="xref">3.1</a>.  <a href="#name-serializing-client-state" class="xref">Serializing Client State</a><a href="#section-toc.1-1.3.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="xref">3.2</a>.  <a href="#name-using-extended-tokens" class="xref">Using Extended Tokens</a><a href="#section-toc.1-1.3.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="xref">3.3</a>.  <a href="#name-transmitting-messages" class="xref">Transmitting Messages</a><a href="#section-toc.1-1.3.2.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc compact ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-stateless-intermediaries" class="xref">Stateless Intermediaries</a><a href="#section-toc.1-1.4.1" class="pilcrow">¶</a></p>
<ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="xref">4.1</a>.  <a href="#name-observing-resources" class="xref">Observing Resources</a><a href="#section-toc.1-1.4.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="xref">4.2</a>.  <a href="#name-block-wise-transfers" class="xref">Block-Wise Transfers</a><a href="#section-toc.1-1.4.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="xref">4.3</a>.  <a href="#name-gateway-timeouts" class="xref">Gateway Timeouts</a><a href="#section-toc.1-1.4.2.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a href="#section-4.4" class="xref">4.4</a>.  <a href="#name-extended-tokens-2" class="xref">Extended Tokens</a><a href="#section-toc.1-1.4.2.4.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc compact ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-security-considerations" class="xref">Security Considerations</a><a href="#section-toc.1-1.5.1" class="pilcrow">¶</a></p>
<ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-extended-tokens-3" class="xref">Extended Tokens</a><a href="#section-toc.1-1.5.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-stateless-clients-and-inter" class="xref">Stateless Clients and Intermediaries</a><a href="#section-toc.1-1.5.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc compact ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-iana-considerations" class="xref">IANA Considerations</a><a href="#section-toc.1-1.6.1" class="pilcrow">¶</a></p>
<ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="xref">6.1</a>.  <a href="#name-coap-signaling-option-numbe" class="xref">CoAP Signaling Option Number</a><a href="#section-toc.1-1.6.2.1.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc compact ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-references" class="xref">References</a><a href="#section-toc.1-1.7.1" class="pilcrow">¶</a></p>
<ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="xref">7.1</a>.  <a href="#name-normative-references" class="xref">Normative References</a><a href="#section-toc.1-1.7.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="xref">7.2</a>.  <a href="#name-informative-references" class="xref">Informative References</a><a href="#section-toc.1-1.7.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc compact ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-appendix.a" class="xref">Appendix A</a>.  <a href="#name-updated-message-formats" class="xref">Updated Message Formats</a><a href="#section-toc.1-1.8.1" class="pilcrow">¶</a></p>
<ul class="toc compact ulEmpty">
<li class="toc compact ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-a.1" class="xref">A.1</a>.  <a href="#name-coap-over-udp" class="xref">CoAP over UDP</a><a href="#section-toc.1-1.8.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-a.2" class="xref">A.2</a>.  <a href="#name-coap-over-tcp-tls" class="xref">CoAP over TCP/TLS</a><a href="#section-toc.1-1.8.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="toc compact ulEmpty" id="section-toc.1-1.8.2.3">
                <p id="section-toc.1-1.8.2.3.1"><a href="#section-a.3" class="xref">A.3</a>.  <a href="#name-coap-over-websockets" class="xref">CoAP over WebSockets</a><a href="#section-toc.1-1.8.2.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="toc compact ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-appendix.b" class="xref"></a><a href="#name-acknowledgements" class="xref">Acknowledgements</a><a href="#section-toc.1-1.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="toc compact ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-appendix.c" class="xref"></a><a href="#name-authors-address" class="xref">Author's Address</a><a href="#section-toc.1-1.10.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">
        The Constrained Application Protocol (CoAP) <span>[<a href="#RFC7252" class="xref">RFC7252</a>]</span> is
        a RESTful application-layer protocol for <span><a href="#RFC7228" class="xref">constrained environments</a> [<a href="#RFC7228" class="xref">RFC7228</a>]</span>. In CoAP, clients (or
        intermediaries in the client role) make requests to servers (or
        intermediaries in the server role), which satisfy the requests by
        returning responses.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">
        While a request is ongoing, a client typically needs to keep some state that
        it requires for processing the response when that arrives. Identification
        of this state is done in CoAP by means of a token, an
        opaque sequence of bytes chosen by the client and included in the CoAP
        request, and that is returned by the server verbatim in any resulting CoAP
        response (<a href="#stateful-exchange" class="xref">Figure 1</a>).<a href="#section-1-2" class="pilcrow">¶</a></p>
<span id="name-token-as-an-identifier-for-"></span><div id="stateful-exchange">
<figure id="figure-1">
        <div class="artwork art-text alignCenter" id="section-1-3.1">
<pre>
+-----------------+     request with     +------------+
|        |        |   state identifier   |            |
|        |        |       as token       |            |
|    .-&lt;-+-&gt;------|---------------------&gt;|------.     |
|   _|_           |                      |      |     |
|  /   \ stored   |                      |      |     |
|  \___/ state    |                      |      |     |
|    |            |                      |      |     |
|    '-&gt;-+-&lt;------|&lt;---------------------|------'     |
|        |        |     response with    |            |
|        v        |   token echoed back  |            |
+-----------------+                      +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-token-as-an-identifier-for-" class="selfRef">Token as an Identifier for Request State</a>
        </figcaption></figure>
</div>
<p id="section-1-4">
        In some scenarios, it can be beneficial to reduce the amount of state
        that is stored at the client at the cost of increased message sizes. A client can
        opt into this by serializing (parts of) its state into the token itself and then
        recovering this state from the token in the response (<a href="#stateless-exchange" class="xref">Figure 2</a>).<a href="#section-1-4" class="pilcrow">¶</a></p>
<span id="name-token-as-serialization-of-r"></span><div id="stateless-exchange">
<figure id="figure-2">
        <div class="artwork art-text alignCenter" id="section-1-5.1">
<pre>
+-----------------+     request with     +------------+
|        |        |   serialized state   |            |
|        |        |       as token       |            |
|        +--------|=====================&gt;|------.     |
|                 |                      |      |     |
|    look ma,     |                      |      |     |
|    no state!    |                      |      |     |
|                 |                      |      |     |
|        +--------|&lt;=====================|------'     |
|        |        |     response with    |            |
|        v        |   token echoed back  |            |
+-----------------+                      +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-token-as-serialization-of-r" class="selfRef">Token as Serialization of Request State</a>
        </figcaption></figure>
</div>
<p id="section-1-6">
        <a href="#stateless-clients" class="xref">Section 3</a> of this document provides
        considerations for clients becoming "stateless" in this way.
        (The term "stateless" is in quotes here, because it's a bit
        oversimplified. Such clients still need to maintain per-server state and other
        kinds of state. So it would be more accurate to
        just say that the clients are avoiding per-request state.)<a href="#section-1-6" class="pilcrow">¶</a></p>
<p id="section-1-7">
        <a href="#stateless-intermediaries" class="xref">Section 4</a> of this document
        extends the considerations for clients to intermediaries, which
        may not only want to avoid keeping state for the requests they
        send to servers but also for the requests they receive from
        clients.<a href="#section-1-7" class="pilcrow">¶</a></p>
<p id="section-1-8">
        The serialization of state into tokens is limited by the fact
        that both <span><a href="#RFC7252" class="xref">CoAP over UDP</a> [<a href="#RFC7252" class="xref">RFC7252</a>]</span> and <span><a href="#RFC8323" class="xref">CoAP over reliable transports</a> [<a href="#RFC8323" class="xref">RFC8323</a>]</span> restrict
        the maximum token length to 8 bytes. To overcome this
        limitation, <a href="#extended-tokens" class="xref">Section 2</a> of this document
        first introduces a CoAP protocol extension for extended token
        lengths.<a href="#section-1-8" class="pilcrow">¶</a></p>
<p id="section-1-9">
         While the use case (avoiding per-request state) and the mechanism
         (extended token lengths) presented in this document are closely
         related, both can be used independently of each other: Some
         implementations may be able to fit their state in just 8 bytes; some
         implementations may have other use cases for extended token lengths.<a href="#section-1-9" class="pilcrow">¶</a></p>
<section id="section-1.1">
        <h3 id="name-terminology">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-terminology" class="section-name selfRef">Terminology</a>
        </h3>
<p id="section-1.1-1">
          In this document, the term "stateless" refers to an implementation
          strategy for a client (or intermediary in the client role) that does
          not require it to keep state for the individual requests it sends to a
          server (or intermediary in the server role). The client still needs to
          keep state for each server it communicates with (e.g., for token
          generation, message retransmission, and congestion control).<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1-2">
          The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
          "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and
          "OPTIONAL" in this document are to be interpreted as described in
          <span><a href="#RFC2119" class="xref">BCP 14</a> [<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span> when,
          and only when, they appear in all capitals, as shown here.<a href="#section-1.1-2" class="pilcrow">¶</a></p>
</section>
</section>
</div>
<div id="extended-tokens">
<section id="section-2">
      <h2 id="name-extended-tokens">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-extended-tokens" class="section-name selfRef">Extended Tokens</a>
      </h2>
<p id="section-2-1">
        This document updates the message formats defined for <span><a href="#RFC7252" class="xref">CoAP over UDP</a> [<a href="#RFC7252" class="xref">RFC7252</a>]</span> and <span><a href="#RFC8323" class="xref">CoAP
        over TCP, TLS, and WebSockets</a> [<a href="#RFC8323" class="xref">RFC8323</a>]</span> with a new definition of the TKL
        field.<a href="#section-2-1" class="pilcrow">¶</a></p>
<div id="tkl-field">
<section id="section-2.1">
        <h3 id="name-extended-token-length-tkl-f">
<a href="#section-2.1" class="section-number selfRef">2.1. </a><a href="#name-extended-token-length-tkl-f" class="section-name selfRef">Extended Token Length (TKL) Field</a>
        </h3>
<p id="section-2.1-1">
          The definition of the TKL field is updated as follows:<a href="#section-2.1-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2.1-2">
          <dt id="section-2.1-2.1">Token Length (TKL):</dt>
          <dd style="margin-left: 1.5em" id="section-2.1-2.2">
            <p id="section-2.1-2.2.1">
              4-bit unsigned integer. A value between 0 and 12 inclusive
              indicates the length of the variable-length Token field in bytes.
              The other three values are reserved for special constructs:<a href="#section-2.1-2.2.1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2.1-2.2.2">
              <dt id="section-2.1-2.2.2.1">13:</dt>
              <dd style="margin-left: 1.5em" id="section-2.1-2.2.2.2">
                  An 8-bit unsigned integer directly precedes the Token field and
                  indicates the length of the Token field minus 13.<a href="#section-2.1-2.2.2.2" class="pilcrow">¶</a>
</dd>
              <dd class="break"></dd>
<dt id="section-2.1-2.2.2.3">14:</dt>
              <dd style="margin-left: 1.5em" id="section-2.1-2.2.2.4">
                  A 16-bit unsigned integer in network byte order directly precedes the
                  Token field and indicates the length of the Token field minus
                  269.<a href="#section-2.1-2.2.2.4" class="pilcrow">¶</a>
</dd>
              <dd class="break"></dd>
<dt id="section-2.1-2.2.2.5">15:</dt>
              <dd style="margin-left: 1.5em" id="section-2.1-2.2.2.6">
                  Reserved. This value MUST NOT be sent and MUST be processed as
                  a message format error.<a href="#section-2.1-2.2.2.6" class="pilcrow">¶</a>
</dd>
            <dd class="break"></dd>
</dl>
</dd>
        <dd class="break"></dd>
</dl>
<p id="section-2.1-3">
          All other fields retain their definitions.<a href="#section-2.1-3" class="pilcrow">¶</a></p>
<p id="section-2.1-4">
          The updated message formats are illustrated in <a href="#message-formats" class="xref">Appendix A</a>.<a href="#section-2.1-4" class="pilcrow">¶</a></p>
<p id="section-2.1-5">
          The new definition of the TKL field increases the maximum token length that can be represented in a
          message to 65804 bytes. However, the maximum token length that sender and
          recipient implementations support may be shorter. For example, a
          constrained node of <span><a href="#RFC7228" class="xref">Class 1</a> [<a href="#RFC7228" class="xref">RFC7228</a>]</span> might
          support extended token lengths only up to 32 bytes.<a href="#section-2.1-5" class="pilcrow">¶</a></p>
<p id="section-2.1-6">
          In CoAP over UDP, it is often beneficial to keep CoAP messages small
          enough to avoid IP fragmentation. The maximum practical token length
          may therefore also be influenced by the Path MTU. See Section 4.6 of
          RFC 7252 for details.<a href="#section-2.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="discovery">
<section id="section-2.2">
        <h3 id="name-discovering-support">
<a href="#section-2.2" class="section-number selfRef">2.2. </a><a href="#name-discovering-support" class="section-name selfRef">Discovering Support</a>
        </h3>
<p id="section-2.2-1">
          Extended token lengths require support from server implementations.
          Support can be discovered by a client implementation in one of two
          ways:<a href="#section-2.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.2-2.1">
              Where Capabilities and Settings Messages (CSMs) are available,
              such as in CoAP over TCP, support can be discovered using the
              Extended-Token-Length Capability Option defined in <a href="#capability-option" class="xref">Section 2.2.1</a>.<a href="#section-2.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.2-2.2">
              Otherwise, such as in CoAP over UDP, support can only be
              discovered by trial-and-error, as described in <a href="#trial-and-error" class="xref">Section 2.2.2</a>.<a href="#section-2.2-2.2" class="pilcrow">¶</a>
</li>
        </ul>
<div id="capability-option">
<section id="section-2.2.1">
          <h4 id="name-extended-token-length-capab">
<a href="#section-2.2.1" class="section-number selfRef">2.2.1. </a><a href="#name-extended-token-length-capab" class="section-name selfRef">Extended-Token-Length Capability Option</a>
          </h4>
<p id="section-2.2.1-1">
            A server can use the elective Extended-Token-Length Capability
            Option to indicate the maximum token length it can accept in
            requests.<a href="#section-2.2.1-1" class="pilcrow">¶</a></p>
<span id="name-the-extended-token-length-c"></span><div id="capability-option-definition">
<table class="center" id="table-1">
            <caption>
<a href="#table-1" class="selfRef">Table 1</a>:
<a href="#name-the-extended-token-length-c" class="selfRef">The Extended-Token-Length Capability Option</a>
            </caption>
<thead>
              <tr>
                <th class="text-right" rowspan="1" colspan="1">#</th>
                <th class="text-left" rowspan="1" colspan="1">C</th>
                <th class="text-left" rowspan="1" colspan="1">R</th>
                <th class="text-left" rowspan="1" colspan="1">Applies to</th>
                <th class="text-left" rowspan="1" colspan="1">Name</th>
                <th class="text-left" rowspan="1" colspan="1">Format</th>
                <th class="text-left" rowspan="1" colspan="1">Length</th>
                <th class="text-left" rowspan="1" colspan="1">Base Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-right" rowspan="1" colspan="1">TBD</td>
                <td class="text-left" rowspan="1" colspan="1"></td>
                <td class="text-left" rowspan="1" colspan="1"></td>
                <td class="text-left" rowspan="1" colspan="1">CSM</td>
                <td class="text-left" rowspan="1" colspan="1">Extended-Token-Length</td>
                <td class="text-left" rowspan="1" colspan="1">uint</td>
                <td class="text-left" rowspan="1" colspan="1">0-3</td>
                <td class="text-left" rowspan="1" colspan="1">8</td>
              </tr>
            </tbody>
          </table>
</div>
<p id="section-2.2.1-3" class="keepWithPrevious">C=Critical, R=Repeatable<a href="#section-2.2.1-3" class="pilcrow">¶</a></p>
<p id="section-2.2.1-4">
            As per Section 3 of RFC 7252, the base value (and the value used
            when this option is not implemented) is 8.<a href="#section-2.2.1-4" class="pilcrow">¶</a></p>
<p id="section-2.2.1-5">
            The active value of the Extended-Token-Length Option is replaced
            each time the option is sent with a modified value. Its starting
            value is its base value.<a href="#section-2.2.1-5" class="pilcrow">¶</a></p>
<p id="section-2.2.1-6">
            The option value MUST NOT be less than 8 or greater than 65804. If
            an option value less than 8 is received, the option MUST be ignored.
            If an option value greater than 65804 is received, the option value
            MUST be set to 65804.<a href="#section-2.2.1-6" class="pilcrow">¶</a></p>
<p id="section-2.2.1-7">
            Any option value greater than 8 implies support for the new
            definition of the TKL field specified in <a href="#tkl-field" class="xref">Section 2.1</a>.
            Indication of support by a server does not oblige a client to
            actually make use of token lengths greater than 8.<a href="#section-2.2.1-7" class="pilcrow">¶</a></p>
<p id="section-2.2.1-8">
            If a server receives a request with a token of a length greater than what
            it indicated in its Extended-Token-Length Option, it MUST handle the
            request as a message format error.<a href="#section-2.2.1-8" class="pilcrow">¶</a></p>
<p id="section-2.2.1-9">
            If a server receives a request with a token of a length less than or
            equal to what it indicated in its Extended-Token-Length Option but
            is unwilling or unable to handle the token at that time, it MUST NOT
            handle the request as a message format error. Instead, it SHOULD
            return a 5.03 (Service Unavailable) response.<a href="#section-2.2.1-9" class="pilcrow">¶</a></p>
<p id="section-2.2.1-10">
            The Extended-Token-Length Capability Option does not apply to
            responses. The sender of a request is simply expected not to use a
            token of a length greater than it is willing to accept in a
            response.<a href="#section-2.2.1-10" class="pilcrow">¶</a></p>
</section>
</div>
<div id="trial-and-error">
<section id="section-2.2.2">
          <h4 id="name-trial-and-error">
<a href="#section-2.2.2" class="section-number selfRef">2.2.2. </a><a href="#name-trial-and-error" class="section-name selfRef">Trial-and-Error</a>
          </h4>
<p id="section-2.2.2-1">
            A server implementation that does not support the updated definition of the TKL
            field specified in <a href="#tkl-field" class="xref">Section 2.1</a> will consider a
            request with a TKL field value outside the range 0 to 8 a message
            format error and reject it (Section 3 of RFC 7252). A client can
            therefore determine support by sending a request with an extended
            token length and checking whether it is rejected by the server or
            not.<a href="#section-2.2.2-1" class="pilcrow">¶</a></p>
<p id="section-2.2.2-2">
            In CoAP over UDP, the way a request message is rejected depends on the message type.
            A Confirmable message with a message format error
            is rejected with a Reset message (Section 4.2 of RFC 7252). A
            Non-confirmable message with a message format error is either rejected
            with a Reset message or just silently ignored (Section 4.3 of RFC
            7252). To reliably get a Reset message, it is therefore REQUIRED that clients use a Confirmable
            message for determining support.<a href="#section-2.2.2-2" class="pilcrow">¶</a></p>
<p id="section-2.2.2-3">
            As per RFC 7252, Reset messages are empty and do not contain a
            token; they only return the Message ID (<a href="#trial-and-error-illustration" class="xref">Figure 3</a>). They also do not contain
            any indication of what caused a message format error. To avoid any
            ambiguity, it is therefore RECOMMENDED that clients use a request
            that has no potential message format error other than the extended
            token length.<a href="#section-2.2.2-3" class="pilcrow">¶</a></p>
<span id="name-a-confirmable-request-with-"></span><div id="trial-and-error-illustration">
<figure id="figure-3">
            <div class="artwork art-text alignCenter" id="section-2.2.2-4.1">
<pre>
+-----------------+   request message    +------------+
|        |        |    with extended     |            |
|        |        |     token length     |            |
|    .-&lt;-+-&gt;------|---------------------&gt;|------.     |
|   _|_           |                      |      |     |
|  /   \ stored   |                      |      |     |
|  \___/ state    |                      |      |     |
|    |            |                      |      |     |
|    '-&gt;-+-&lt;------|&lt;---------------------|------'     |
|        |        |     reset message    |            |
|        v        |   with only message  |            |
+-----------------+    ID echoed back    +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-a-confirmable-request-with-" class="selfRef">A Confirmable Request With an Extended Token is Rejected With a Reset Message if the Server Does Not Have Support</a>
            </figcaption></figure>
</div>
<p id="section-2.2.2-5">
            An example of a suitable request is a GET request in a Confirmable  message that
            includes only an If-None-Match option and a token of the greatest length
            that the client intends to use. Any response with the same token
            echoed back indicates that tokens up to that length are supported by
            the server.<a href="#section-2.2.2-5" class="pilcrow">¶</a></p>
<p id="section-2.2.2-6">
            Since network addresses may change, a client SHOULD NOT assume that extended token
            lengths are supported by a server for an unlimited duration.
            Unless additional information is available, the client should assume that addresses (and therefore extended token lengths) are valid for a minimum of 1800s, and for a maximum of 86400s (1 day).
            A client may use additional forms of input into this determination.
            For instance a client may assume a server which is in the same subnet as the client has a similiar address lifetime as the client.
            The client may use DHCP lease times or Router Advertisements to set the limits.
            For servers which is not local, if the server was looked up using DNS, then the DNS resource record will have a Time To Live, and the extended token length should be kept for only that amount of time.<a href="#section-2.2.2-6" class="pilcrow">¶</a></p>
<p id="section-2.2.2-7">
            If a server supports extended token lengths but receives a request
            with a token of a length it is unwilling or unable to handle, it
            MUST NOT reject the message, as that would imply that extended token
            lengths are not supported at all. Instead, if the server cannot
            handle the request at the time, it SHOULD return a 5.03 (Service
            Unavailable) response; if the server will never be able to handle the request
            (e.g., because the token is too large), it SHOULD return a 4.00 (Bad
            Request) response.<a href="#section-2.2.2-7" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2.2.2-8">
            <dt id="section-2.2.2-8.1">Design Note:</dt>
            <dd style="margin-left: 1.5em" id="section-2.2.2-8.2">
                The requirement to return an error response when a
                token cannot be handled might seem somewhat contradictory, as
                returning the error response requires the server also to return the
                token it cannot handle. However,
                processing a request usually involves a number of steps from
                receiving the message to passing it to application logic.
                The idea is that a server implementing this extension
                supports large tokens at least in its first few processing steps, enough to
                return an error response rather than a Reset message.<a href="#section-2.2.2-8.2" class="pilcrow">¶</a>
</dd>
          <dd class="break"></dd>
</dl>
<span class="break"></span><dl class="dlParallel" id="section-2.2.2-9">
            <dt id="section-2.2.2-9.1">Design Note:</dt>
            <dd style="margin-left: 1.5em" id="section-2.2.2-9.2">
                To make the trial-and-error-based discovery not too complicated, no effort is made to indicate the maximum supported
                token length. A client implementation would probably
                already choose the shortest token possible for the task (like
                being stateless as described in <a href="#stateless-clients" class="xref">Section 3</a>), so it would probably not be able
                to reduce the length any further anyway should a server
                indicate a lower limit.<a href="#section-2.2.2-9.2" class="pilcrow">¶</a>
</dd>
          <dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="hop-by-hop">
<section id="section-2.3">
        <h3 id="name-intermediaries">
<a href="#section-2.3" class="section-number selfRef">2.3. </a><a href="#name-intermediaries" class="section-name selfRef">Intermediaries</a>
        </h3>
<p id="section-2.3-1">
          Tokens are a hop-by-hop feature: If there are one or more
          intermediaries between a client and a server, every token is scoped to
          the exchange between a node in the client role and the node in the
          server role that it is immediately interacting with.<a href="#section-2.3-1" class="pilcrow">¶</a></p>
<p id="section-2.3-2">
          When an intermediary receives a request, the only requirement is that
          it echoes the token back in any resulting response. There is no
          requirement or expectation that an intermediary passes a client's
          token on to a server or that an intermediary uses extended token
          lengths itself in its request to satisfy a request with an extended
          token length. Discovery needs to be performed for each hop where extended token lengths are to be used.<a href="#section-2.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="stateless-clients">
<section id="section-3">
      <h2 id="name-stateless-clients">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-stateless-clients" class="section-name selfRef">Stateless Clients</a>
      </h2>
<p id="section-3-1">
        A client can be alleviated of keeping per-request state as follows:<a href="#section-3-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3-2">
<li id="section-3-2.1">
            The client serializes (parts of) its per-request state into
            a sequence of bytes and sends those bytes as the token of
            its request to the server.<a href="#section-3-2.1" class="pilcrow">¶</a>
</li>
        <li id="section-3-2.2">
            The server returns the token verbatim in the response to the
            client, which allows the client to recover the state and
            process the response as if it had kept the state locally.<a href="#section-3-2.2" class="pilcrow">¶</a>
</li>
      </ol>
<p id="section-3-3">
        As servers are just expected to return any token verbatim to the
        client, this implementation strategy for clients does not impact the
        interoperability of client and server implementations. However,
        there are a number of significant, non-obvious implications
        (e.g., related to security and other CoAP protocol features)
        that client implementations need take into consideration.<a href="#section-3-3" class="pilcrow">¶</a></p>
<p id="section-3-4">
        The following subsections discuss some of these considerations.<a href="#section-3-4" class="pilcrow">¶</a></p>
<div id="serialized-state">
<section id="section-3.1">
        <h3 id="name-serializing-client-state">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-serializing-client-state" class="section-name selfRef">Serializing Client State</a>
        </h3>
<p id="section-3.1-1">
          The format of the serialized state is generally an
          implementation detail of the client and opaque to the server.

          However, serialized state information is an attractive target
          for both unwanted nodes (e.g., on-path attackers) and wanted
          nodes (e.g., any configured forward proxy) on the path.

          The serialization format therefore needs to include security
          measures such as the following:<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-2.1">
              A client SHOULD protect the integrity of the state information
              serialized in a token.<a href="#section-3.1-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.1-2.2">
              Even when the integrity of the serialized state is protected, an
              attacker may still replay a response, making the client
              believe it sent the same request twice.

              For this reason, the client SHOULD implement replay
              protection (e.g., by using sequence numbers and a replay
              window).

              For replay protection, integrity protection is REQUIRED.<a href="#section-3.1-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.1-2.3">
              If processing a response without keeping request state is
              sensitive to the time elapsed since sending the request, then the
              client SHOULD include freshness information (e.g., a timestamp) in
              the serialized state and reject any response where the freshness
              information is insufficiently fresh.<a href="#section-3.1-2.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.1-2.4">
              Information in the serialized state may be privacy
              sensitive.

              A client SHOULD encrypt the serialized state if it
              contains privacy sensitive information that an attacker
              would not get otherwise.<a href="#section-3.1-2.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.1-2.5">
              When a client changes the format of the serialized state,
              it SHOULD prevent false interoperability with the previous
              format (e.g., by changing the key used for integrity
              protection or changing a field in the serialized state).<a href="#section-3.1-2.5" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<section id="section-3.2">
        <h3 id="name-using-extended-tokens">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-using-extended-tokens" class="section-name selfRef">Using Extended Tokens</a>
        </h3>
<p id="section-3.2-1">
          A client that depends on
          support for extended token lengths (<a href="#extended-tokens" class="xref">Section 2</a>)
          from the server to avoid keeping request state needs to perform a
          discovery of support (<a href="#discovery" class="xref">Section 2.2</a>) before it can be
          stateless.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">
          This discovery MUST be performed in a stateful way, i.e.,
          keeping state for the request (<a href="#stateful-discovery" class="xref">Figure 4</a>):
          If the client was stateless from the start and the server does not
          support extended tokens, then any error message could not be processed
          since the state would neither be present at the client nor returned in
          the Reset message (<a href="#stateless-discovery" class="xref">Figure 5</a>).<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<span id="name-depending-on-extended-token"></span><div id="stateful-discovery">
<figure id="figure-4">
          <div class="artwork art-text alignCenter" id="section-3.2-3.1">
<pre>
+-----------------+    dummy request     +------------+
|        |        |    with extended     |            |
|        |        |        token         |            |
|    .-&lt;-+-&gt;------|=====================&gt;|------.     |
|   _|_           |                      |      |     |
|  /   \ stored   |                      |      |     |
|  \___/ state    |                      |      |     |
|    |            |                      |      |     |
|    '-&gt;-+-&lt;------|&lt;=====================|------'     |
|        |        |     response with    |            |
|        |        |    extended token    |            |
|        |        |      echoed back     |            |
|        |        |                      |            |
|        |        |                      |            |
|        |        |     request with     |            |
|        |        |   serialized state   |            |
|        |        |       as token       |            |
|        +--------|=====================&gt;|------.     |
|                 |                      |      |     |
|    look ma,     |                      |      |     |
|    no state!    |                      |      |     |
|                 |                      |      |     |
|        +--------|&lt;=====================|------'     |
|        |        |     response with    |            |
|        v        |   token echoed back  |            |
+-----------------+                      +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-depending-on-extended-token" class="selfRef">Depending on Extended Tokens for Being Stateless First Requires a Successful Stateful Discovery of Support</a>
          </figcaption></figure>
</div>
<span id="name-stateless-discovery-of-supp"></span><div id="stateless-discovery">
<figure id="figure-5">
          <div class="artwork art-text alignCenter" id="section-3.2-4.1">
<pre>
+-----------------+    dummy request     +------------+
|        |        |    with extended     |            |
|        |        |        token         |            |
|        +--------|=====================&gt;|------.     |
|                 |                      |      |     |
|                 |                      |      |     |
|                 |                      |      |     |
|                 |                      |      |     |
|              ???|&lt;---------------------|------'     |
|                 |     reset message    |            |
|                 |   with only message  |            |
+-----------------+    ID echoed back    +------------+
      Client                                 Server
</pre>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-stateless-discovery-of-supp" class="selfRef">Stateless Discovery of Support Does Not Work</a>
          </figcaption></figure>
</div>
<p id="section-3.2-5">
          In environments where support can be reliably discovered through some
          other means, the discovery of support is OPTIONAL. An example for this
          is the <span><a href="#I-D.ietf-6tisch-minimal-security" class="xref">Constrained
          Join Protocol (CoJP) in a 6TiSCH network</a> [<a href="#I-D.ietf-6tisch-minimal-security" class="xref">I-D.ietf-6tisch-minimal-security</a>]</span>, where support for
          extended tokens is required from all relevant parties.<a href="#section-3.2-5" class="pilcrow">¶</a></p>
</section>
<section id="section-3.3">
        <h3 id="name-transmitting-messages">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-transmitting-messages" class="section-name selfRef">Transmitting Messages</a>
        </h3>
<p id="section-3.3-1">
          In <span><a href="#RFC7252" class="xref">CoAP over UDP</a> [<a href="#RFC7252" class="xref">RFC7252</a>]</span>, a client has the choice between
          Confirmable and Non-confirmable messages for requests. When using
          Non-confirmable messages, a client does not have to keep any message
          exchange state, which can help in the goal of avoiding state. When using
          Confirmable messages, a client needs to keep message exchange
          state for performing retransmissions and handling Acknowledgement and
          Reset messages, however. Non-confirmable messages are therefore better suited for avoiding state.
          In any case, a client still needs to keep congestion control state, i.e.,
          maintain state for each node it communicates with and enforce limits
          like NSTART.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<p id="section-3.3-2">
          As per Section 5.2 of RFC 7252, a client must be prepared to receive a response as a
          piggybacked response, a separate response, or Non-confirmable response,
          regardless of the message type used for the
          request. A stateless client MUST handle these response types as
          follows:<a href="#section-3.3-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.3-3.1">
              If a piggybacked response passes the checks for token integrity
              and freshness (<a href="#serialized-state" class="xref">Section 3.1</a>), the client processes the message as
              specified in RFC 7252; otherwise, it processes the acknowledgement
              portion of the message as specified in RFC 7252 and silently
              discards the response portion.<a href="#section-3.3-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.3-3.2">
              If a separate response passes the checks for token integrity and
              freshness, the client processes the message as specified in
              RFC 7252; otherwise, it rejects the message as specified in
              Section 4.2 of RFC 7252.<a href="#section-3.3-3.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.3-3.3">
              If a Non-confirmable response passes the checks for token
              integrity and freshness, the client processes the message
              as specified in RFC 7252; otherwise, it rejects the message as
              specified in Section 4.3 of RFC 7252.<a href="#section-3.3-3.3" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</section>
</div>
<div id="stateless-intermediaries">
<section id="section-4">
      <h2 id="name-stateless-intermediaries">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-stateless-intermediaries" class="section-name selfRef">Stateless Intermediaries</a>
      </h2>
<p id="section-4-1">
        Tokens are a hop-by-hop feature: If a client makes a request to an
        intermediary, that intermediary needs to store the client's token
        (along with the client's transport address) while it makes its own
        request towards the origin server and waits for the
        response. When the intermediary receives the response, it looks up
        the client's token and transport address for the received request and
        sends an appropriate response to the client.<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">
        An intermediary might want to be "stateless" not only in its role as
        a client but also in its role as a server, i.e., be
        alleviated of storing the client information for
        the requests it receives.<a href="#section-4-2" class="pilcrow">¶</a></p>
<p id="section-4-3">
        Such an intermediary can be implemented by serializing the
        client information along with the request state into the token towards the origin server.
        When the intermediary receives the response, it can recover
        the client information from the token and use it to satisfy the client's
        request and therefore doesn't need to store it itself.<a href="#section-4-3" class="pilcrow">¶</a></p>
<p id="section-4-4">
        The following subsections discuss some considerations for this approach.<a href="#section-4-4" class="pilcrow">¶</a></p>
<section id="section-4.1">
        <h3 id="name-observing-resources">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-observing-resources" class="section-name selfRef">Observing Resources</a>
        </h3>
<p id="section-4.1-1">
          One drawback of the approach is that an intermediary, without keeping
          request state, is unable to aggregate multiple requests for the same
          target resource, which can significantly reduce efficiency. In
          particular, when clients <span><a href="#RFC7641" class="xref">observe</a> [<a href="#RFC7641" class="xref">RFC7641</a>]</span> the
          same resource, aggregating requests is REQUIRED (Section 3.1 of RFC
          7641). This requirement cannot be satisfied without keeping request
          state.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1-2">
          Furthermore, an intermediary that does not keep track of the clients
          observing a resource is not able to determine whether these
          clients are still interested in receiving further notifications
          (Section 3.5 of RFC 7641) or want to cancel an observation (Section 3.6 of
          RFC 7641).<a href="#section-4.1-2" class="pilcrow">¶</a></p>
<p id="section-4.1-3">
          Therefore, an intermediary MUST NOT include an Observe Option in
          requests it sends without keeping both the request state for the requests it sends and the
          client information for the requests it receives.<a href="#section-4.1-3" class="pilcrow">¶</a></p>
</section>
<section id="section-4.2">
        <h3 id="name-block-wise-transfers">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-block-wise-transfers" class="section-name selfRef">Block-Wise Transfers</a>
        </h3>
<p id="section-4.2-1">
          When using <span><a href="#RFC7959" class="xref">block-wise transfers</a> [<a href="#RFC7959" class="xref">RFC7959</a>]</span>, a
          server might not be able to distinguish blocks originating from
          different clients once they have been forwarded by an intermediary.
          Intermediaries need to ensure that this does not lead to inconsistent
          resource state by keeping distinct block-wise request operations on
          the same resource apart, e.g., utilizing the <span><a href="#I-D.ietf-core-echo-request-tag" class="xref">Request-Tag Option</a> [<a href="#I-D.ietf-core-echo-request-tag" class="xref">I-D.ietf-core-echo-request-tag</a>]</span>.<a href="#section-4.2-1" class="pilcrow">¶</a></p>
</section>
<section id="section-4.3">
        <h3 id="name-gateway-timeouts">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-gateway-timeouts" class="section-name selfRef">Gateway Timeouts</a>
        </h3>
<p id="section-4.3-1">
          As per Section 5.7.1 of RFC 7252, an intermediary is REQUIRED to
          return a 5.04 (Gateway Timeout) response if it cannot obtain a
          response within a timeout. However, if an intermediary does not keep
          the client information for the requests it receives, it cannot return
          such a response. Therefore, in this case, the gateway cannot return
          such a response and as such cannot implement such a timeout.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
</section>
<section id="section-4.4">
        <h3 id="name-extended-tokens-2">
<a href="#section-4.4" class="section-number selfRef">4.4. </a><a href="#name-extended-tokens-2" class="section-name selfRef">Extended Tokens</a>
        </h3>
<p id="section-4.4-1">
          A client may make use of extended token lengths in a request to an
          intermediary that wants to be "stateless". This means that such an intermediary
          may have to serialize potentially very large client information into
          its token towards the origin server. The tokens can grow even further
          when it progresses along a chain of intermediaries that all want to be
          "stateless".<a href="#section-4.4-1" class="pilcrow">¶</a></p>
<p id="section-4.4-2">
          Intermediaries SHOULD limit the size of client information they're
          serializing into their own tokens. An intermediary can do this, for
          example, by limiting the extended token lengths it accepts from its
          clients (see <a href="#discovery" class="xref">Section 2.2</a>) or by keeping the client
          information locally when the client information exceeds the limit
          (i.e., not being "stateless").<a href="#section-4.4-2" class="pilcrow">¶</a></p>
</section>
</section>
</div>
<div id="security">
<section id="section-5">
      <h2 id="name-security-considerations">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<section id="section-5.1">
        <h3 id="name-extended-tokens-3">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-extended-tokens-3" class="section-name selfRef">Extended Tokens</a>
        </h3>
<p id="section-5.1-1">
          Tokens significantly larger than the 8 bytes specified in RFC 7252
          have implications in particular for nodes with constrained memory size
          that need to be mitigated. A node in the server role supporting
          extended token lengths may be vulnerable to a denial-of-service when
          an attacker (either on-path or a malicious client) sends large tokens
          to fill up the memory of the node. Implementations need to be prepared
          to handle such messages.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
</section>
<section id="section-5.2">
        <h3 id="name-stateless-clients-and-inter">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-stateless-clients-and-inter" class="section-name selfRef">Stateless Clients and Intermediaries</a>
        </h3>
<p id="section-5.2-1">
          Transporting the state needed by a client to process a response as
          serialized state information in the token has several significant and
          non-obvious security and privacy implications that need to be
          mitigated; see <a href="#serialized-state" class="xref">Section 3.1</a> for recommendations.

          In addition to the format requirements outlined there, implementations
          need to ensure that they are not vulnerable to maliciously crafted,
          delayed, or replayed tokens.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2-2">
          It is generally expected that the use of encryption, integrity
          protection, and replay protection for serialized state is appropriate.

          In the absence of integrity and reply protection, an on-path attacker
          or rogue server/intermediary could return a state (either one modified
          in a reply, or an unsolicited one) that could alter the internal state
          of the client.

          However, a careful analysis of any potential attacks to the security
          and privacy properties of the system might reveal that there are cases
          where such cryptographic protections do not add value in a specific
          case.<a href="#section-5.2-2" class="pilcrow">¶</a></p>
<p id="section-5.2-3">
          <span><a href="#RFC3610" class="xref">AES-CCM</a> [<a href="#RFC3610" class="xref">RFC3610</a>]</span> with a 64-bit tag is
          RECOMMENDED, combined with a sequence number and a replay window.

          Where encryption is not needed, <span><a href="#RFC6234" class="xref">HMAC-SHA-256</a> [<a href="#RFC6234" class="xref">RFC6234</a>]</span>, combined with a sequence number
          and a replay window, may be used.<a href="#section-5.2-3" class="pilcrow">¶</a></p>
<p id="section-5.2-4">
          When using an encryption mode that depends on a nonce, such as AES-CCM, repeated use of the same nonce under the same key
          causes the cipher to fail catastrophically. If a nonce is ever used
          for more than one encryption operation with the same key, then the
          same key stream gets used to encrypt both plaintexts and the
          confidentiality guarantees are voided. Devices with low-quality entropy
          sources -- as is typical with constrained devices, which incidentally
          happen to be a natural candidate for the stateless mechanism described
          in this document -- need to carefully pick a nonce generation
          mechanism that provides the above uniqueness guarantee. Additionally,
          since it can be difficult to use AES-CCM securely when using
          statically configured keys, implementations should use <span><a href="#RFC4107" class="xref">automated key management</a> [<a href="#RFC4107" class="xref">RFC4107</a>]</span>.<a href="#section-5.2-4" class="pilcrow">¶</a></p>
</section>
</section>
</div>
<section id="section-6">
      <h2 id="name-iana-considerations">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<section id="section-6.1">
        <h3 id="name-coap-signaling-option-numbe">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-coap-signaling-option-numbe" class="section-name selfRef">CoAP Signaling Option Number</a>
        </h3>
<p id="section-6.1-1">
          The following entries are added to the "CoAP Signaling Option Numbers"
          registry within the "CoRE Parameters" registry.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<table class="center" id="table-2">
          <caption><a href="#table-2" class="selfRef">Table 2</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Applies to</th>
              <th class="text-right" rowspan="1" colspan="1">Number</th>
              <th class="text-left" rowspan="1" colspan="1">Name</th>
              <th class="text-left" rowspan="1" colspan="1">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">7.01</td>
              <td class="text-right" rowspan="1" colspan="1">TBD</td>
              <td class="text-left" rowspan="1" colspan="1">Extended-Token-Length</td>
              <td class="text-left" rowspan="1" colspan="1">[[this document]]</td>
            </tr>
          </tbody>
        </table>
<p id="section-6.1-3">
          [[NOTE TO RFC EDITOR: Please replace "TBD" in this section and in
          <a href="#capability-option-definition" class="xref">Table 1</a> with the code point
          assigned by IANA.]]<a href="#section-6.1-3" class="pilcrow">¶</a></p>
</section>
</section>
<section id="section-7">
      <h2 id="name-references">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-7.1">
        <h3 id="name-normative-references">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7252">[RFC7252]</dt>
        <dd>
<span class="refAuthor">Shelby, Z.</span><span class="refAuthor">, Hartke, K.</span><span class="refAuthor">, and C. Bormann</span>, <span class="refTitle">"The Constrained Application Protocol (CoAP)"</span>, <span class="seriesInfo">RFC 7252</span>, <span class="seriesInfo">DOI 10.17487/RFC7252</span>, <time datetime="2014-06" class="refDate">June 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7252">https://www.rfc-editor.org/info/rfc7252</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7641">[RFC7641]</dt>
        <dd>
<span class="refAuthor">Hartke, K.</span>, <span class="refTitle">"Observing Resources in the Constrained Application Protocol (CoAP)"</span>, <span class="seriesInfo">RFC 7641</span>, <span class="seriesInfo">DOI 10.17487/RFC7641</span>, <time datetime="2015-09" class="refDate">September 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7641">https://www.rfc-editor.org/info/rfc7641</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7959">[RFC7959]</dt>
        <dd>
<span class="refAuthor">Bormann, C.</span><span class="refAuthor"> and Z. Shelby, Ed.</span>, <span class="refTitle">"Block-Wise Transfers in the Constrained Application Protocol (CoAP)"</span>, <span class="seriesInfo">RFC 7959</span>, <span class="seriesInfo">DOI 10.17487/RFC7959</span>, <time datetime="2016-08" class="refDate">August 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7959">https://www.rfc-editor.org/info/rfc7959</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8323">[RFC8323]</dt>
      <dd>
<span class="refAuthor">Bormann, C.</span><span class="refAuthor">, Lemay, S.</span><span class="refAuthor">, Tschofenig, H.</span><span class="refAuthor">, Hartke, K.</span><span class="refAuthor">, Silverajan, B.</span><span class="refAuthor">, and B. Raymor, Ed.</span>, <span class="refTitle">"CoAP (Constrained Application Protocol) over TCP, TLS, and WebSockets"</span>, <span class="seriesInfo">RFC 8323</span>, <span class="seriesInfo">DOI 10.17487/RFC8323</span>, <time datetime="2018-02" class="refDate">February 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8323">https://www.rfc-editor.org/info/rfc8323</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-7.2">
        <h3 id="name-informative-references">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.ietf-6tisch-minimal-security">[I-D.ietf-6tisch-minimal-security]</dt>
        <dd>
<span class="refAuthor">Vucinic, M.</span><span class="refAuthor">, Simon, J.</span><span class="refAuthor">, Pister, K.</span><span class="refAuthor">, and M. Richardson</span>, <span class="refTitle">"Constrained Join Protocol (CoJP) for 6TiSCH"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-6tisch-minimal-security-15</span>, <time datetime="2019-12-10" class="refDate">10 December 2019</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-6tisch-minimal-security-15.txt">http://www.ietf.org/internet-drafts/draft-ietf-6tisch-minimal-security-15.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-core-echo-request-tag">[I-D.ietf-core-echo-request-tag]</dt>
        <dd>
<span class="refAuthor">Amsuess, C.</span><span class="refAuthor">, Mattsson, J.</span><span class="refAuthor">, and G. Selander</span>, <span class="refTitle">"CoAP: Echo, Request-Tag, and Token Processing"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-core-echo-request-tag-10</span>, <time datetime="2020-07-13" class="refDate">13 July 2020</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-core-echo-request-tag-10.txt">http://www.ietf.org/internet-drafts/draft-ietf-core-echo-request-tag-10.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3610">[RFC3610]</dt>
        <dd>
<span class="refAuthor">Whiting, D.</span><span class="refAuthor">, Housley, R.</span><span class="refAuthor">, and N. Ferguson</span>, <span class="refTitle">"Counter with CBC-MAC (CCM)"</span>, <span class="seriesInfo">RFC 3610</span>, <span class="seriesInfo">DOI 10.17487/RFC3610</span>, <time datetime="2003-09" class="refDate">September 2003</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3610">https://www.rfc-editor.org/info/rfc3610</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4107">[RFC4107]</dt>
        <dd>
<span class="refAuthor">Bellovin, S.</span><span class="refAuthor"> and R. Housley</span>, <span class="refTitle">"Guidelines for Cryptographic Key Management"</span>, <span class="seriesInfo">BCP 107</span>, <span class="seriesInfo">RFC 4107</span>, <span class="seriesInfo">DOI 10.17487/RFC4107</span>, <time datetime="2005-06" class="refDate">June 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4107">https://www.rfc-editor.org/info/rfc4107</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6234">[RFC6234]</dt>
        <dd>
<span class="refAuthor">Eastlake 3rd, D.</span><span class="refAuthor"> and T. Hansen</span>, <span class="refTitle">"US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)"</span>, <span class="seriesInfo">RFC 6234</span>, <span class="seriesInfo">DOI 10.17487/RFC6234</span>, <time datetime="2011-05" class="refDate">May 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6234">https://www.rfc-editor.org/info/rfc6234</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7228">[RFC7228]</dt>
      <dd>
<span class="refAuthor">Bormann, C.</span><span class="refAuthor">, Ersue, M.</span><span class="refAuthor">, and A. Keranen</span>, <span class="refTitle">"Terminology for Constrained-Node Networks"</span>, <span class="seriesInfo">RFC 7228</span>, <span class="seriesInfo">DOI 10.17487/RFC7228</span>, <time datetime="2014-05" class="refDate">May 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7228">https://www.rfc-editor.org/info/rfc7228</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="message-formats">
<section id="section-appendix.a">
      <h2 id="name-updated-message-formats">
<a href="#section-appendix.a" class="section-number selfRef">Appendix A. </a><a href="#name-updated-message-formats" class="section-name selfRef">Updated Message Formats</a>
      </h2>
<p id="section-appendix.a-1">
        In <a href="#extended-tokens" class="xref">Section 2</a>, this document updates the
        CoAP message formats by specifying a new definition of the TKL
        field in the message header. As an alternative presentation of
        this update, this appendix shows the CoAP message formats for
        <span><a href="#RFC7252" class="xref">CoAP over UDP</a> [<a href="#RFC7252" class="xref">RFC7252</a>]</span> and <span><a href="#RFC8323" class="xref">CoAP over TCP, TLS, and WebSockets</a> [<a href="#RFC8323" class="xref">RFC8323</a>]</span> with
        the new definition applied.<a href="#section-appendix.a-1" class="pilcrow">¶</a></p>
<section id="section-a.1">
        <h2 id="name-coap-over-udp">
<a href="#section-a.1" class="section-number selfRef">A.1. </a><a href="#name-coap-over-udp" class="section-name selfRef">CoAP over UDP</a>
        </h2>
<div class="artwork art-text alignCenter" id="section-a.1-1">
<pre>
                0   1   2   3   4   5   6   7
              +-------+-------+---------------+
              |       |       |               |
              |  Ver  |   T   |      TKL      |   1 byte
              |       |       |               |
              +-------+-------+---------------+
              |                               |
              |             Code              |   1 byte
              |                               |
              +-------------------------------+
              |                               |
              |                               |
              |                               |
              +-         Message ID          -+   2 bytes
              |                               |
              |                               |
              |                               |
              +-------------------------------+
              \                               \
              /              TKL              /   0-2 bytes
              \          (extended)           \
              +-------------------------------+
              \                               \
              /             Token             /   0-65804 bytes
              \                               \
              +-------------------------------+
              \                               \
              /                               /
              \                               \
              /            Options            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +---------------+---------------+
              |               |               |
              |      15       |       15      |   1 byte (if payload)
              |               |               |
              +---------------+---------------+
              \                               \
              /                               /
              \                               \
              /            Payload            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +-------------------------------+
</pre><a href="#section-a.1-1" class="pilcrow">¶</a>
</div>
</section>
<section id="section-a.2">
        <h2 id="name-coap-over-tcp-tls">
<a href="#section-a.2" class="section-number selfRef">A.2. </a><a href="#name-coap-over-tcp-tls" class="section-name selfRef">CoAP over TCP/TLS</a>
        </h2>
<div class="artwork art-text alignCenter" id="section-a.2-1">
<pre>
                0   1   2   3   4   5   6   7
              +---------------+---------------+
              |               |               |
              |      Len      |      TKL      |   1 byte
              |               |               |
              +---------------+---------------+
              \                               \
              /              Len              /   0-4 bytes
              \          (extended)           \
              +-------------------------------+
              |                               |
              |             Code              |   1 byte
              |                               |
              +-------------------------------+
              \                               \
              /              TKL              /   0-2 bytes
              \          (extended)           \
              +-------------------------------+
              \                               \
              /             Token             /   0-65804 bytes
              \                               \
              +-------------------------------+
              \                               \
              /                               /
              \                               \
              /            Options            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +---------------+---------------+
              |               |               |
              |      15       |       15      |   1 byte (if payload)
              |               |               |
              +---------------+---------------+
              \                               \
              /                               /
              \                               \
              /            Payload            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +-------------------------------+
</pre><a href="#section-a.2-1" class="pilcrow">¶</a>
</div>
</section>
<section id="section-a.3">
        <h2 id="name-coap-over-websockets">
<a href="#section-a.3" class="section-number selfRef">A.3. </a><a href="#name-coap-over-websockets" class="section-name selfRef">CoAP over WebSockets</a>
        </h2>
<div class="artwork art-text alignCenter" id="section-a.3-1">
<pre>
                0   1   2   3   4   5   6   7
              +---------------+---------------+
              |               |               |
              |       0       |      TKL      |   1 byte
              |               |               |
              +---------------+---------------+
              |                               |
              |             Code              |   1 byte
              |                               |
              +-------------------------------+
              \                               \
              /              TKL              /   0-2 bytes
              \          (extended)           \
              +-------------------------------+
              \                               \
              /             Token             /   0-65804 bytes
              \                               \
              +-------------------------------+
              \                               \
              /                               /
              \                               \
              /            Options            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +---------------+---------------+
              |               |               |
              |      15       |       15      |   1 byte (if payload)
              |               |               |
              +---------------+---------------+
              \                               \
              /                               /
              \                               \
              /            Payload            /   0 or more bytes
              \                               \
              /                               /
              \                               \
              +-------------------------------+
</pre><a href="#section-a.3-1" class="pilcrow">¶</a>
</div>
</section>
</section>
</div>
<section id="section-appendix.b">
      <h2 id="name-acknowledgements">
<a href="#name-acknowledgements" class="section-name selfRef">Acknowledgements</a>
      </h2>
<p id="section-appendix.b-1">
        This document is based on the requirements of and work on the <span><a href="#I-D.ietf-6tisch-minimal-security" class="xref">Minimal Security Framework for
        6TiSCH</a> [<a href="#I-D.ietf-6tisch-minimal-security" class="xref">I-D.ietf-6tisch-minimal-security</a>]</span> by Malisa Vucinic, Jonathan Simon, Kris Pister, and
        Michael Richardson.<a href="#section-appendix.b-1" class="pilcrow">¶</a></p>
<p id="section-appendix.b-2">
        Thanks to
        Christian Amsuss,
        Carsten Bormann,
        Roman Danyliw,
        Christer Holmberg,
        Benjamin Kaduk,
        Ari Keranen,
        Erik Kline,
        Murray Kucherawy,
        Warren Kumari,
        Barry Leiba,
        David Mandelberg,
        Dan Romascanu,
        Jim Schaad,
        Goran Selander,
        Malisa Vucinic,
        Eric Vyncke, and
        Robert Wilton
        for helpful comments and discussions that have shaped the document.<a href="#section-appendix.b-2" class="pilcrow">¶</a></p>
<p id="section-appendix.b-3">
        Special thanks to John Mattsson for his contributions to the security
        considerations of the document, and to Thomas Fossati for his in-depth
        review, copious comments, and suggested text.<a href="#section-appendix.b-3" class="pilcrow">¶</a></p>
</section>
<div id="authors-addresses">
<section id="section-appendix.c">
      <h2 id="name-authors-address">
<a href="#name-authors-address" class="section-name selfRef">Author's Address</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Klaus Hartke</span></div>
<div dir="auto" class="left"><span class="org">Ericsson</span></div>
<div dir="auto" class="left"><span class="street-address">Torshamnsgatan 23</span></div>
<div dir="auto" class="left">SE-<span class="postal-code">16483</span> <span class="locality">Stockholm</span>
</div>
<div dir="auto" class="left"><span class="country-name">Sweden</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:klaus.hartke@ericsson.com" class="email">klaus.hartke@ericsson.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
